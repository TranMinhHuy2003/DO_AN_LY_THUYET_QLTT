CREATE DATABASE QLXD;
USE QLXD;
-- TẠO BẢNG
CREATE TABLE DOANHNGHIEPNK (
    MADN CHAR(4) NOT NULL,
    TENDN VARCHAR(40),
    NGAYTL DATETIME,
    DIACHI VARCHAR(40),
    SDT VARCHAR(20),
    LOAIDN VARCHAR(20)
);
CREATE TABLE LOAIXANG (
    MALX CHAR(4) NOT NULL,
    TENLX VARCHAR(40),
    MDBQ VARCHAR(20)
);
CREATE TABLE XANGDAU (
    MAXD CHAR(4) NOT NULL,
    TENXD VARCHAR(40),
    MALX CHAR(4),
    GIACOSO DECIMAL(10 , 3 ),
    THUEPHI INT
);
CREATE TABLE CUAHANG (
    MACH CHAR(4) NOT NULL,
    TENCH VARCHAR(40),
    BACCL VARCHAR(2),
    RONGDD FLOAT,
    CAOTB FLOAT,
    CAOMC FLOAT,
    DIACHI VARCHAR(40)
);
CREATE TABLE NHAVANCHUYEN (
    MANVC CHAR(4) NOT NULL,
    TENNVC VARCHAR(40),
    SDT VARCHAR(20),
    DIACHI VARCHAR(40)
);
CREATE TABLE HOADON (
    SOHD CHAR(4) NOT NULL,
    MADN CHAR(4),
    MACH CHAR(4), 
    MANVC CHAR(4) NOT NULL,
    NGHD DATETIME,
    NGAYVC DATETIME,
    TRIGIA DECIMAL(20 , 3 )
);

CREATE TABLE CTHD (
    SOHD CHAR(4),
    MAXD CHAR(4),
    SOLUONG INT,
    GIANHAP DECIMAL(10 , 3 )
);

CREATE TABLE DN_XD (
    MADN CHAR(4),
    MAXD CHAR(4),
    NGAYNK DATETIME
);

-- KHÓA CHÍNH
ALTER TABLE DOANHNGHIEPNK ADD PRIMARY KEY (MADN);
ALTER TABLE LOAIXANG ADD PRIMARY KEY (MALX);
ALTER TABLE XANGDAU ADD PRIMARY KEY (MAXD);
ALTER TABLE CUAHANG ADD PRIMARY KEY (MACH);
ALTER TABLE NHAVANCHUYEN ADD PRIMARY KEY (MANVC);
ALTER TABLE HOADON ADD PRIMARY KEY (SOHD);
ALTER TABLE CTHD ADD PRIMARY KEY (SOHD, MAXD);
ALTER TABLE DN_XD ADD PRIMARY KEY (MADN, MAXD, NGAYNK);

-- KHÓA NGOẠI
ALTER TABLE XANGDAU ADD CONSTRAINT FK_xdMALX FOREIGN KEY (MALX) REFERENCES LOAIXANG(MALX);

ALTER TABLE HOADON ADD CONSTRAINT FK_hdMADN FOREIGN KEY (MADN) REFERENCES DOANHNGHIEPNK(MADN);
ALTER TABLE HOADON ADD CONSTRAINT FK_hdMACH FOREIGN KEY (MACH) REFERENCES CUAHANG(MACH);
ALTER TABLE HOADON ADD CONSTRAINT FK_hdMANVC FOREIGN KEY (MANVC) REFERENCES NHAVANCHUYEN(MANVC);

ALTER TABLE CTHD ADD CONSTRAINT FK_cthdpMAXD FOREIGN KEY (MAXD) REFERENCES XANGDAU(MAXD);
ALTER TABLE CTHD ADD CONSTRAINT FK_cthdSOHD FOREIGN KEY (SOHD) REFERENCES HOADON(SOHD);

ALTER TABLE DN_XD ADD CONSTRAINT FK_dnxdMADN FOREIGN KEY (MADN) REFERENCES DOANHNGHIEPNK(MADN);
ALTER TABLE DN_XD ADD CONSTRAINT FK_dnxdMAXD FOREIGN KEY (MAXD) REFERENCES XANGDAU(MAXD);

-- TRIGGER 
-- 1. NGAYNK (DN_XD) không nhỏ hơn NGAYTL (DNNK) của doanh nghiệp nhập khẩu xăng dầu đó

DELIMITER $$
CREATE TRIGGER update_dnnk 
BEFORE UPDATE ON doanhnghiepnk 
FOR EACH ROW
BEGIN
    IF (SELECT MIN(NGAYNK) FROM DN_XD WHERE MADN = NEW.MADN) < (SELECT NEW.NGAYTL) 
    THEN 
			SIGNAL SQLSTATE '45000'
			SET MESSAGE_TEXT = 'NGÀY NHẬP KHẨU KHÔNG ĐƯỢC NHỎ HƠN NGÀY THÀNH LẬP CỦA DOANH NGHIỆP!';
	END IF; 
END$$
DELIMITER ;

DELIMITER $$
CREATE TRIGGER insert_dnxd 
BEFORE INSERT ON dn_xd 
FOR EACH ROW
BEGIN
    IF (SELECT NEW.NGAYNK) < (SELECT NGAYTL FROM doanhnghiepnk WHERE MADN = NEW.MADN) 
    THEN 
			SIGNAL SQLSTATE '45000'
			SET MESSAGE_TEXT = 'NGÀY NHẬP KHẨU KHÔNG ĐƯỢC NHỎ HƠN NGÀY THÀNH LẬP CỦA DOANH NGHIỆP!';
	END IF; 
END$$
DELIMITER ;

-- 1.1 THỰC THI 
INSERT INTO DN_XD VALUES ("DN01","XD01","2022-01-10"); -- THÀNH CÔNG 
INSERT INTO DN_XD VALUES ("DN01","XD01","1955-01-10"); -- THẤT BẠI
-- 1.2 KHÔI PHỤC DỮ LIỆU 
DELETE FROM DN_XD WHERE MADN = 'DN01' AND MAXD = 'XD01' AND NGAYNK = '2022-01-10';

-- 2. Cửa hàng phải đạt BACCL là I hoặc II, CHIEUCAOMC phải lớn hơn hoặc bằng 4.75m, RONGDD lớn hơn hoặc bằng 6.5m
-- , CAOTUONGBAO không nhỏ hơn 2.2m thì mới được phép nhập xăng dầu để bán
DELIMITER $$
CREATE TRIGGER insert_cuahang 
BEFORE INSERT ON CUAHANG 
FOR EACH ROW
BEGIN
    IF (SELECT NEW.BACCL) NOT IN ('I','II')
    THEN 
			SIGNAL SQLSTATE '45000'
			SET MESSAGE_TEXT = 'BẬC CHỊU LỬA PHẢI LÀ I HOẶC II!';
	END IF;
	IF (SELECT NEW.RONGDD) < 6.5 
    THEN 
			SIGNAL SQLSTATE '45000'
			SET MESSAGE_TEXT = 'CHIỀU RỘNG ĐƯỜNG ĐI PHẢI LỚN HƠN HOẶC BẰNG 6.5m!';
	END IF; 
    IF (SELECT NEW.CAOTB) < 2.2 
    THEN 
			SIGNAL SQLSTATE '45000'
			SET MESSAGE_TEXT = 'CHIỀU CAO TƯỜNG BAO KHÔNG ĐƯỢC NHỎ HƠN 2.2m!';
	END IF; 
    IF (SELECT NEW.CAOMC) < 4.75 
    THEN 
			SIGNAL SQLSTATE '45000'
			SET MESSAGE_TEXT = 'CHIỀU CAO MÁI CHE PHẢI LỚN HƠN HOẶC BẰNG 4.75m!';
	END IF; 
END$$
DELIMITER ;

DELIMITER $$
CREATE TRIGGER update_cuahang 
BEFORE UPDATE ON CUAHANG 
FOR EACH ROW
BEGIN
    IF (SELECT NEW.BACCL) NOT IN ('I','II')
    THEN 
			SIGNAL SQLSTATE '45000'
			SET MESSAGE_TEXT = 'BẬC CHỊU LỬA PHẢI LÀ I HOẶC II!';
	END IF;
	IF (SELECT NEW.RONGDD) < 6.5 
    THEN 
			SIGNAL SQLSTATE '45000'
			SET MESSAGE_TEXT = 'CHIỀU RỘNG ĐƯỜNG ĐI PHẢI LỚN HƠN HOẶC BẰNG 6.5m!';
	END IF; 
    IF (SELECT NEW.CAOTB) < 2.2 
    THEN 
			SIGNAL SQLSTATE '45000'
			SET MESSAGE_TEXT = 'CHIỀU CAO TƯỜNG BAO KHÔNG ĐƯỢC NHỎ HƠN 2.2m!';
	END IF; 
    IF (SELECT NEW.CAOMC) < 4.75 
    THEN 
			SIGNAL SQLSTATE '45000'
			SET MESSAGE_TEXT = 'CHIỀU CAO MÁI CHE PHẢI LỚN HƠN HOẶC BẰNG 4.75m!';
	END IF; 
END$$
DELIMITER ;

-- 2.1 THỰC THI 
-- THẤT BẠI DO CHIỀU RỘNG ĐƯỜNG ĐI NHỎ HƠN 6.5m
INSERT INTO CUAHANG VALUES ("CH11","Petrolimex-03","I",6,2.5,5.0,"TP.Điện Biên Phủ, Điện Biên"); 
INSERT INTO CUAHANG VALUES ("CH11","Petrolimex-03","I",6.5,2.5,5.0, "TP.Điện Biên Phủ, Điện Biên"); -- THÀNH CÔNG 
-- 2.2 KHÔI PHỤC DỮ LIỆU
DELETE FROM CUAHANG WHERE MACH = 'CH11';

-- 3. Tự động cập nhật GIANHAP = GIACOSO + (THUEPHI / 100) * GIACOSO
DELIMITER $$
CREATE TRIGGER insert_cthd_gianhap
BEFORE INSERT ON cthd
FOR EACH ROW
BEGIN
	DECLARE GIACS DECIMAL(10,3);
    DECLARE THUE INT;
    SELECT GIACOSO INTO GIACS FROM xangdau WHERE MAXD = NEW.MAXD;
    SELECT THUEPHI INTO THUE FROM xangdau WHERE MAXD = NEW.MAXD;
    SET NEW.GIANHAP = GIACS + (THUE * 1.0 / 100) * GIACS;
END$$
DELIMITER ;

DELIMITER $$
CREATE TRIGGER update_cthd_gianhap
BEFORE UPDATE ON cthd
FOR EACH ROW
BEGIN
	DECLARE GIACS DECIMAL(10,3);
    DECLARE THUE INT;
    SELECT GIACOSO INTO GIACS FROM xangdau WHERE MAXD = NEW.MAXD;
    SELECT THUEPHI INTO THUE FROM xangdau WHERE MAXD = NEW.MAXD;
    SET NEW.GIANHAP = GIACS + (THUE * 1.0 / 100) * GIACS;
END$$
DELIMITER ;

DELIMITER $$
CREATE TRIGGER update_xangdau_giacoso_thuephi
AFTER UPDATE ON xangdau
FOR EACH ROW
BEGIN
    UPDATE CTHD 
    SET GIANHAP = NEW.GIACOSO + (NEW.THUEPHI * 1.0 / 100) * NEW.GIACOSO
    WHERE MAXD = NEW.MAXD;
END$$
DELIMITER ;

-- 3.1 THỰC THI
INSERT INTO CTHD VALUES ("HD01","XD01",500,0);

-- THUEPHI ban đầu của XD02 là 8%, sau khi sửa thì GIANHAP của XD02 thay đổi 
UPDATE XANGDAU
SET THUEPHI = 10
WHERE MAXD = 'XD02';
-- 3.2 KIỂM TRA
SELECT * FROM CTHD;
-- 3.3 KHÔI PHỤC DỮ LIỆU
DELETE FROM CTHD WHERE SOHD = 'HD01' AND MAXD = 'XD01';
UPDATE XANGDAU
SET THUEPHI = 8
WHERE MAXD = 'XD02';

-- 4. Tự động cập nhật TRIGIA của hoá đơn bằng tổng SOLUONG * GIANHAP của tất cả các xăng dầu trong hóa đơn đó
DELIMITER $$
CREATE TRIGGER insert_cthd
AFTER INSERT ON CTHD 
FOR EACH ROW
BEGIN
	UPDATE HOADON 
    SET TRIGIA = (SELECT SUM(SOLUONG*GIANHAP) FROM CTHD WHERE SOHD = NEW.SOHD)
    WHERE SOHD = NEW.SOHD;
END$$
DELIMITER ;

DELIMITER $$
CREATE TRIGGER del_cthd
AFTER DELETE ON CTHD 
FOR EACH ROW
BEGIN
	UPDATE HOADON 
    SET TRIGIA = (SELECT SUM(SOLUONG*GIANHAP) FROM CTHD WHERE SOHD = OLD.SOHD)
    WHERE SOHD = OLD.SOHD;
END$$
DELIMITER ;

DELIMITER $$
CREATE TRIGGER update_cthd
AFTER UPDATE ON CTHD 
FOR EACH ROW
BEGIN
	UPDATE HOADON 
    SET TRIGIA = (SELECT SUM(SOLUONG*GIANHAP) FROM CTHD WHERE SOHD = NEW.SOHD)
    WHERE SOHD = NEW.SOHD;
END$$
DELIMITER ;

-- 4.1 THỰC THI 
INSERT INTO CTHD VALUES ("HD01","XD01",500,0);
DELETE FROM CTHD WHERE SOHD = 'HD01' AND MAXD = 'XD01';
UPDATE CTHD SET SOLUONG = 1000 WHERE SOHD = 'HD01' AND MAXD = 'XD02';

-- 4.2 KHÔI PHỤC DỮ LIỆU
UPDATE CTHD SET SOLUONG = 2500 WHERE SOHD = 'HD01' AND MAXD = 'XD02';

-- 4.3 KIỂM TRA
SELECT * FROM CTHD
SELECT * FROM HOADON 

-- 5. TRIGIA của hóa đơn không được khác tổng SOLUONG * GIANHAP của tất cả các xăng dầu trong hóa đơn đó
DELIMITER $$
CREATE TRIGGER insert_hoadon_trigia
BEFORE INSERT ON HOADON 
FOR EACH ROW
BEGIN
    IF(NEW.TRIGIA != 0)
	THEN 
			SIGNAL SQLSTATE '45000'
			SET MESSAGE_TEXT = 'Trị giá hóa đơn không đúng!';
	END IF; 
END$$
DELIMITER ;

DELIMITER $$
CREATE TRIGGER update_hoadon_trigia
BEFORE UPDATE ON HOADON 
FOR EACH ROW
BEGIN
    IF(NEW.TRIGIA != (SELECT SUM(SOLUONG*GIANHAP) FROM CTHD WHERE SOHD = NEW.SOHD))
	THEN 
			SIGNAL SQLSTATE '45000'
			SET MESSAGE_TEXT = 'Trị giá hóa đơn không đúng!';
	END IF; 
END$$
DELIMITER ;

-- 5.1 THỰC THI 
INSERT INTO HOADON VALUES ("HD24","DN06","CH10","VC08","2023-02-11","2023-02-15",100); -- THẤT BẠI
INSERT INTO HOADON VALUES ("HD24","DN06","CH10","VC08","2023-02-11","2023-02-15",0); -- THÀNH CÔNG
UPDATE HOADON SET TRIGIA = 5 WHERE SOHD = 'HD22';-- THẤT BẠI
-- 5.2 KHÔI PHỤC DỮ LIỆU
DELETE FROM HOADON WHERE SOHD = 'HD24'

-- 6. MDBQ của 1 loại xăng chỉ có các loại sau: IA, IB, II, III, IV và V
DELIMITER $$
CREATE TRIGGER insert_loaixang
BEFORE INSERT ON loaixang 
FOR EACH ROW
BEGIN
	IF (SELECT NEW.MDBQ) NOT IN ('IA', 'IB', 'II', 'III', 'IV', 'V')
    THEN 
		SIGNAL SQLSTATE '45000'
		SET MESSAGE_TEXT = 'Mức độ bảo quản của 1 loại xăng chỉ có các loại sau: IA, IB, II, III, IV và V';
	END IF; 
END$$
DELIMITER ;

DELIMITER $$
CREATE TRIGGER update_loaixang_mdbq
BEFORE UPDATE ON loaixang 
FOR EACH ROW
BEGIN
	IF (SELECT NEW.MDBQ) NOT IN ('IA', 'IB', 'II', 'III', 'IV', 'V')
    THEN 
		SIGNAL SQLSTATE '45000'
		SET MESSAGE_TEXT = 'Mức độ bảo quản của 1 loại xăng chỉ có các loại sau: IA, IB, II, III, IV và V';
	END IF; 
END$$
DELIMITER ;

-- 6.1 THỰC THI 
UPDATE LOAIXANG 
SET MDBQ = 'IIA'
WHERE MALX = 'LX06'; -- THẤT BẠI 

UPDATE LOAIXANG 
SET MDBQ = 'IA'
WHERE MALX = 'LX06'; -- THÀNH CÔNG
-- 6.2 KHÔI PHỤC DỮ LIỆU 
UPDATE LOAIXANG 
SET MDBQ = 'V'
WHERE MALX = 'LX06'; 

-- 7. NGAYVC của 1 hóa đơn không được nhỏ hơn NGHD của hóa đơn đó 
DELIMITER $$
CREATE TRIGGER insert_hoadon_ngayvc_ngayhd 
BEFORE INSERT ON HOADON
FOR EACH ROW
BEGIN
	IF (NEW.NGAYVC < NEW.NGHD)
    THEN 
		SIGNAL SQLSTATE '45000'
		SET MESSAGE_TEXT = 'Ngày vận chuyển không được nhỏ hơn ngày lập hóa đơn';
	END IF; 
END$$
DELIMITER ;

DELIMITER $$
CREATE TRIGGER update_hoadon_ngayvc_ngayhd 
BEFORE UPDATE ON HOADON
FOR EACH ROW
BEGIN
	IF (NEW.NGAYVC < NEW.NGHD)
    THEN 
		SIGNAL SQLSTATE '45000'
		SET MESSAGE_TEXT = 'Ngày vận chuyển không được nhỏ hơn ngày lập hóa đơn';
	END IF; 
END$$
DELIMITER ;

-- 7.1. THỰC THI 
INSERT INTO HOADON VALUES ("HD24","DN06","CH10","VC03","2023-03-18","2023-03-17",0); -- THẤT BẠI
INSERT INTO HOADON VALUES ("HD24","DN06","CH10","VC03","2023-03-18","2023-03-19",0); -- THÀNH CÔNG 
-- 7.2. KHÔI PHỤC DỮ LIỆU 
DELETE FROM HOADON WHERE SOHD = 'HD24';

-- du lieu
-- DOANHNGHIEPNK
INSERT INTO DOANHNGHIEPNK VALUES ("DN01","Petrolimex","1956-01-12","Q.Đống Đa, Hà Nội","02438512603","Cty cổ phần NN");
INSERT INTO DOANHNGHIEPNK VALUES ("DN02","PVOil","2008-06-06","Q.1, TP.HCM","02839106990","Cty cổ phần NN");
INSERT INTO DOANHNGHIEPNK VALUES ("DN03","Cty TNHH Thủy bộ Hải Hà","2003-09-16","Huyện Thái Thụy, Thái Bình","02273713464","Cty TNHH ngoài NN");
INSERT INTO DOANHNGHIEPNK VALUES ("DN04","Cty TNHH Hải Linh","2000-09-01","TP.Việt Trì, Phú Thọ","02103857463","Cty TNHH ngoài NN");
INSERT INTO DOANHNGHIEPNK VALUES ("DN05","NSH Petro","2012-02-14","Huyện Châu Thành, Hậu Giang","02926547979","Cty cổ phần NN");
INSERT INTO DOANHNGHIEPNK VALUES ("DN06","Cty Xuyên Việt Oil","2005-05-31","Q.3, TP.HCM","0838480480","Cty TNHH ngoài NN");
INSERT INTO DOANHNGHIEPNK VALUES ("DN07","Tổng Cty Thương mại XNK Thanh Lễ","1991-01-01","TP.Thủ Dầu Một, Bình Dương","02743829534","Cty cổ phần NN");
INSERT INTO DOANHNGHIEPNK VALUES ("DN08","PETIMEX","1992-12-11","TP.Cao Lãnh, Đồng Tháp","02773851056","Cty cổ phần NN");
INSERT INTO DOANHNGHIEPNK VALUES ("DN09","Cty Thiên Minh Đức","2001-09-04","TP.Vinh, Nghệ An","0383563507","Cty cổ phần ngoài NN");
INSERT INTO DOANHNGHIEPNK VALUES ("DN10","Mipec","2003-12-22","Q.Hoàn Kiếm, Hà Nội","02437342501","Cty cổ phần NN");
-- LOAIXANG
INSERT INTO LOAIXANG VALUES ("LX01","Xăng RON 95-III","III");
INSERT INTO LOAIXANG VALUES ("LX02","Xăng E5 RON 92-II","II");
INSERT INTO LOAIXANG VALUES ("LX03","Dầu DO 0,05S-II","II");
INSERT INTO LOAIXANG VALUES ("LX04","Dầu KO","II");
INSERT INTO LOAIXANG VALUES ("LX05","Dầu DO 0,001S-V","V");
INSERT INTO LOAIXANG VALUES ("LX06","Xăng RON 95-V","V");
-- XANGDAU
INSERT INTO XANGDAU VALUES ("XD01","Xăng E5 A92 vùng 1","LX02",22680,8);
INSERT INTO XANGDAU VALUES ("XD02","Xăng E5 A92 vùng 2","LX02",23130,8);
INSERT INTO XANGDAU VALUES ("XD03","Xăng A95-V vùng 1","LX06",24530,10);
INSERT INTO XANGDAU VALUES ("XD04","Xăng A95-V vùng 2","LX06",25020,10);
INSERT INTO XANGDAU VALUES ("XD05","Xăng A95-III vùng 1","LX01",23630,10);
INSERT INTO XANGDAU VALUES ("XD06","Xăng A95-III vùng 2","LX01",24100,10);
INSERT INTO XANGDAU VALUES ("XD07","Dầu Diesel 0,001S-V vùng 1","LX05",20820,8);
INSERT INTO XANGDAU VALUES ("XD08","Dầu Diesel 0,001S-V vùng 2","LX05",21230,8);
INSERT INTO XANGDAU VALUES ("XD09","Dầu Diesel 0,05S-II vùng 1","LX03",19390,8);
INSERT INTO XANGDAU VALUES ("XD10","Dầu Diesel 0,05S-II vùng 2","LX03",19770,8);
INSERT INTO XANGDAU VALUES ("XD11","Dầu hỏa vùng 1","LX04",19480,10);
INSERT INTO XANGDAU VALUES ("XD12","Dầu hỏa vùng 2","LX04",19860,10);
-- CUAHANG
INSERT INTO CUAHANG VALUES ("CH01","Petrolimex-01","I",6.5,2.5,5.0,"TP.Điện Biên Phủ, Điện Biên");
INSERT INTO CUAHANG VALUES ("CH02","Petrolimex-02","I",6.7,3.0,4.75,"Q.Phú Xuyên, Hà Nội");
INSERT INTO CUAHANG VALUES ("CH03","PVOil-01","II",7.15,2.7,5.76,"Huyện Xuyên Mộc, Bà Rịa-Vũng Tàu");
INSERT INTO CUAHANG VALUES ("CH04","PVOil-02","II",7.05,2.95,5.47,"Q.Lê Chân, Hải Phòng");
INSERT INTO CUAHANG VALUES ("CH05","CHXD Quân đội","I",6.65,2.85,4.95,"Huyện Tháp Mười, Đồng Tháp");
INSERT INTO CUAHANG VALUES ("CH06","Trạm xăng dầu Tân Phú","II",8.5,2.68,6.7,"Q.9, TP.Thủ Đức, TPHCM");
INSERT INTO CUAHANG VALUES ("CH07","Trạm xăng dầu Mỹ Thành","II",8.0,2.24,6.1,"Q.9, TP.Thủ Đức, TPHCM");
INSERT INTO CUAHANG VALUES ("CH08","Trạm xăng dầu Đông Sài Gòn","II",6.5,2.7,5.05,"Q.9, TP.Thủ Đức, TPHCM");
INSERT INTO CUAHANG VALUES ("CH09","Công ty CP Nhiên Liệu Sài Gòn","II",6.95,4.5,5.7,"Q.2, TP.Thủ Đức, TPHCM");
INSERT INTO CUAHANG VALUES ("CH10","Trạm xăng dầu Dương Anh Thư","I",6.85,3.55,4.82,"Q.2, TP.Thủ Đức, TPHCM");
-- NHAVANCHUYEN
INSERT INTO NHAVANCHUYEN VALUES ("VC01","PVTrans","02839111301","Q.1, TPHCM");
INSERT INTO NHAVANCHUYEN VALUES ("VC02","PV Trans Pacific","02838228546","Q.1, TPHCM");
INSERT INTO NHAVANCHUYEN VALUES ("VC03","Cty CP vận tải Xăng dầu VITACO","02835146024","Q.Bình Thạnh, TPHCM");
INSERT INTO NHAVANCHUYEN VALUES ("VC04","Cty CP vận tải Sản phẩm khí Quốc tế","02822205388","TP.Thủ Đức, TPHCM");
INSERT INTO NHAVANCHUYEN VALUES ("VC05","Cty CP vận tải Thủy Tân Cảng","02837425442","Thị xã Phú Mỹ, Bà Rịa-Vũng Tàu");
INSERT INTO NHAVANCHUYEN VALUES ("VC06","Cty CP vận tải Xăng dầu VIPCO","02253838680","Q.Hồng Bàng, Hải Phòng");
INSERT INTO NHAVANCHUYEN VALUES ("VC07","Cty CP vận tải 1 TRACO","02839111301","Q.Ngô Quyền, Hải Phòng");
INSERT INTO NHAVANCHUYEN VALUES ("VC08","Tổng Cty vận tải PETROLIMEX"," 02435162748","Q.Đống Đa, Hà Nội");
INSERT INTO NHAVANCHUYEN VALUES ("VC09","Cty CP vận tải Xăng dầu Đồng Tháp","02773877011","TP.Cao Lãnh, Đồng Tháp");
INSERT INTO NHAVANCHUYEN VALUES ("VC10","Cty TNHH vận tải Xăng dầu Việt Nam","02432006280","Huyện Quốc Oai, Hà Nội");
-- HOADON
INSERT INTO HOADON VALUES ("HD01","DN01","CH01","VC08","2023-02-11","2023-02-15",0);
INSERT INTO HOADON VALUES ("HD02","DN01","CH01","VC08","2023-02-19","2023-03-23",0);
INSERT INTO HOADON VALUES ("HD03","DN01","CH02","VC08","2023-02-07","2023-03-08",0);
INSERT INTO HOADON VALUES ("HD04","DN01","CH02","VC08","2023-02-16","2023-03-17",0);
INSERT INTO HOADON VALUES ("HD05","DN02","CH03","VC05","2023-02-10","2023-02-11",0);
INSERT INTO HOADON VALUES ("HD06","DN02","CH03","VC05","2023-03-10","2023-03-10",0);
INSERT INTO HOADON VALUES ("HD07","DN01","CH04","VC06","2023-04-01","2023-04-01",0);
INSERT INTO HOADON VALUES ("HD08","DN01","CH04","VC06","2023-04-26","2023-04-26",0);
INSERT INTO HOADON VALUES ("HD09","DN08","CH05","VC09","2023-02-09","2023-02-10",0);
INSERT INTO HOADON VALUES ("HD10","DN08","CH05","VC09","2023-04-20","2023-04-21",0);
INSERT INTO HOADON VALUES ("HD11","DN02","CH06","VC01","2023-01-31","2023-01-31",0);
INSERT INTO HOADON VALUES ("HD12","DN06","CH06","VC01","2023-03-02","2023-03-02",0);
INSERT INTO HOADON VALUES ("HD13","DN06","CH06","VC02","2023-03-09","2023-03-11",0);
INSERT INTO HOADON VALUES ("HD14","DN06","CH07","VC01","2023-02-07","2023-02-07",0);
INSERT INTO HOADON VALUES ("HD15","DN02","CH07","VC01","2023-02-25","2023-02-25",0);
INSERT INTO HOADON VALUES ("HD16","DN02","CH07","VC02","2023-02-25","2023-02-25",0);
INSERT INTO HOADON VALUES ("HD17","DN02","CH07","VC02","2023-03-28","2023-03-28",0);
INSERT INTO HOADON VALUES ("HD18","DN02","CH08","VC02","2023-02-28","2023-02-28",0);
INSERT INTO HOADON VALUES ("HD19","DN02","CH08","VC04","2023-03-06","2023-03-06",0);
INSERT INTO HOADON VALUES ("HD20","DN06","CH09","VC03","2023-05-16","2023-05-17",0);
INSERT INTO HOADON VALUES ("HD21","DN06","CH09","VC01","2023-05-27","2023-05-27",0);
INSERT INTO HOADON VALUES ("HD22","DN02","CH10","VC04","2023-03-09","2023-03-09",0);
INSERT INTO HOADON VALUES ("HD23","DN06","CH10","VC03","2023-03-18","2023-03-19",0);
-- CTHD
-- CH01
INSERT INTO CTHD VALUES ("HD01","XD02",2500,0);
INSERT INTO CTHD VALUES ("HD01","XD06",2000,0);
INSERT INTO CTHD VALUES ("HD01","XD10",1500,0);
INSERT INTO CTHD VALUES ("HD01","XD12",500,0);
INSERT INTO CTHD VALUES ("HD02","XD06",500,0);
-- CH02
INSERT INTO CTHD VALUES ("HD03","XD01",3000,0);
INSERT INTO CTHD VALUES ("HD03","XD05",3000,0);
INSERT INTO CTHD VALUES ("HD03","XD09",2000,0);
INSERT INTO CTHD VALUES ("HD03","XD11",1000,0);
INSERT INTO CTHD VALUES ("HD04","XD09",1000,0);
-- CH03
INSERT INTO CTHD VALUES ("HD05","XD02",2500,0);
INSERT INTO CTHD VALUES ("HD05","XD06",2000,0);
INSERT INTO CTHD VALUES ("HD05","XD10",1500,0);
INSERT INTO CTHD VALUES ("HD05","XD12",500,0);
INSERT INTO CTHD VALUES ("HD06","XD02",2000,0);
-- CH04
INSERT INTO CTHD VALUES ("HD07","XD01",2000,0);
INSERT INTO CTHD VALUES ("HD07","XD05",2000,0);
INSERT INTO CTHD VALUES ("HD07","XD09",2000,0);
INSERT INTO CTHD VALUES ("HD07","XD11",1000,0);
INSERT INTO CTHD VALUES ("HD08","XD01",1000,0);
-- CH05
INSERT INTO CTHD VALUES ("HD09","XD02",2500,0);
INSERT INTO CTHD VALUES ("HD09","XD06",2000,0);
INSERT INTO CTHD VALUES ("HD09","XD10",1500,0);
INSERT INTO CTHD VALUES ("HD10","XD02",1000,0);
INSERT INTO CTHD VALUES ("HD10","XD06",1000,0);
-- CH06
INSERT INTO CTHD VALUES ("HD11","XD01",1000,0);
INSERT INTO CTHD VALUES ("HD11","XD05",1000,0);
INSERT INTO CTHD VALUES ("HD11","XD09",2000,0);
INSERT INTO CTHD VALUES ("HD12","XD01",1000,0);
INSERT INTO CTHD VALUES ("HD13","XD05",1000,0);
-- CH07
INSERT INTO CTHD VALUES ("HD14","XD01",500,0);
INSERT INTO CTHD VALUES ("HD14","XD05",500,0);
INSERT INTO CTHD VALUES ("HD15","XD01",800,0);
INSERT INTO CTHD VALUES ("HD16","XD05",800,0);
INSERT INTO CTHD VALUES ("HD17","XD09",1200,0);
-- CH08
INSERT INTO CTHD VALUES ("HD18","XD01",500,0);
INSERT INTO CTHD VALUES ("HD18","XD05",700,0);
INSERT INTO CTHD VALUES ("HD19","XD01",2000,0);
INSERT INTO CTHD VALUES ("HD19","XD05",1800,0);
INSERT INTO CTHD VALUES ("HD19","XD09",1400,0);
-- CH09
INSERT INTO CTHD VALUES ("HD20","XD01",2000,0);
INSERT INTO CTHD VALUES ("HD20","XD05",2000,0);
INSERT INTO CTHD VALUES ("HD20","XD09",1600,0);
INSERT INTO CTHD VALUES ("HD20","XD11",500,0);
INSERT INTO CTHD VALUES ("HD21","XD09",400,0);
-- CH10
INSERT INTO CTHD VALUES ("HD22","XD01",2000,0);
INSERT INTO CTHD VALUES ("HD22","XD05",2000,0);
INSERT INTO CTHD VALUES ("HD22","XD09",600,0);
INSERT INTO CTHD VALUES ("HD23","XD01",500,0);
INSERT INTO CTHD VALUES ("HD23","XD09",900,0);
-- DN_XD
INSERT INTO DN_XD VALUES ("DN01","XD01","2023-01-10");
INSERT INTO DN_XD VALUES ("DN01","XD02","2023-01-10");
INSERT INTO DN_XD VALUES ("DN01","XD03","2023-01-10");
INSERT INTO DN_XD VALUES ("DN01","XD04","2023-01-10");
INSERT INTO DN_XD VALUES ("DN01","XD05","2023-01-10");
INSERT INTO DN_XD VALUES ("DN01","XD06","2023-01-10");
INSERT INTO DN_XD VALUES ("DN01","XD07","2023-01-10");
INSERT INTO DN_XD VALUES ("DN01","XD08","2023-01-10");
INSERT INTO DN_XD VALUES ("DN01","XD09","2023-01-10");
INSERT INTO DN_XD VALUES ("DN01","XD10","2023-01-10");
INSERT INTO DN_XD VALUES ("DN01","XD11","2023-01-10");
INSERT INTO DN_XD VALUES ("DN01","XD12","2023-01-10");
INSERT INTO DN_XD VALUES ("DN02","XD01","2023-01-07");
INSERT INTO DN_XD VALUES ("DN02","XD02","2023-01-07");
INSERT INTO DN_XD VALUES ("DN02","XD05","2023-01-07");
INSERT INTO DN_XD VALUES ("DN02","XD06","2023-01-07");
INSERT INTO DN_XD VALUES ("DN02","XD09","2023-01-07");
INSERT INTO DN_XD VALUES ("DN02","XD10","2023-01-07");
INSERT INTO DN_XD VALUES ("DN02","XD11","2023-01-07");
INSERT INTO DN_XD VALUES ("DN02","XD12","2023-01-07");
INSERT INTO DN_XD VALUES ("DN03","XD01","2023-01-16");
INSERT INTO DN_XD VALUES ("DN03","XD02","2023-01-16");
INSERT INTO DN_XD VALUES ("DN03","XD05","2023-01-16");
INSERT INTO DN_XD VALUES ("DN03","XD06","2023-01-16");
INSERT INTO DN_XD VALUES ("DN03","XD09","2023-01-16");
INSERT INTO DN_XD VALUES ("DN03","XD10","2023-01-16");
INSERT INTO DN_XD VALUES ("DN03","XD11","2023-01-16");
INSERT INTO DN_XD VALUES ("DN03","XD12","2023-01-16");
INSERT INTO DN_XD VALUES ("DN04","XD01","2023-01-12");
INSERT INTO DN_XD VALUES ("DN04","XD02","2023-01-12");
INSERT INTO DN_XD VALUES ("DN04","XD05","2023-01-12");
INSERT INTO DN_XD VALUES ("DN04","XD06","2023-01-12");
INSERT INTO DN_XD VALUES ("DN04","XD09","2023-01-12");
INSERT INTO DN_XD VALUES ("DN04","XD10","2023-01-12");
INSERT INTO DN_XD VALUES ("DN04","XD11","2023-01-12");
INSERT INTO DN_XD VALUES ("DN04","XD12","2023-01-12");
INSERT INTO DN_XD VALUES ("DN05","XD01","2023-02-14");
INSERT INTO DN_XD VALUES ("DN05","XD02","2023-02-14");
INSERT INTO DN_XD VALUES ("DN05","XD03","2023-02-14");
INSERT INTO DN_XD VALUES ("DN05","XD04","2023-02-14");
INSERT INTO DN_XD VALUES ("DN05","XD05","2023-02-14");
INSERT INTO DN_XD VALUES ("DN05","XD06","2023-02-14");
INSERT INTO DN_XD VALUES ("DN05","XD07","2023-02-14");
INSERT INTO DN_XD VALUES ("DN05","XD08","2023-02-14");
INSERT INTO DN_XD VALUES ("DN05","XD09","2023-02-14");
INSERT INTO DN_XD VALUES ("DN05","XD10","2023-02-14");
INSERT INTO DN_XD VALUES ("DN05","XD11","2023-02-14");
INSERT INTO DN_XD VALUES ("DN05","XD12","2023-02-14");
INSERT INTO DN_XD VALUES ("DN06","XD01","2023-01-03");
INSERT INTO DN_XD VALUES ("DN06","XD02","2023-01-03");
INSERT INTO DN_XD VALUES ("DN06","XD05","2023-01-03");
INSERT INTO DN_XD VALUES ("DN06","XD06","2023-01-03");
INSERT INTO DN_XD VALUES ("DN06","XD09","2023-01-03");
INSERT INTO DN_XD VALUES ("DN06","XD10","2023-01-03");
INSERT INTO DN_XD VALUES ("DN06","XD11","2023-01-03");
INSERT INTO DN_XD VALUES ("DN06","XD12","2023-01-03");
INSERT INTO DN_XD VALUES ("DN07","XD01","2023-02-02");
INSERT INTO DN_XD VALUES ("DN07","XD02","2023-02-02");
INSERT INTO DN_XD VALUES ("DN07","XD05","2023-02-02");
INSERT INTO DN_XD VALUES ("DN07","XD06","2023-02-02");
INSERT INTO DN_XD VALUES ("DN07","XD09","2023-02-02");
INSERT INTO DN_XD VALUES ("DN07","XD10","2023-02-02");
INSERT INTO DN_XD VALUES ("DN07","XD11","2023-02-02");
INSERT INTO DN_XD VALUES ("DN07","XD12","2023-02-02");
INSERT INTO DN_XD VALUES ("DN08","XD01","2023-01-14");
INSERT INTO DN_XD VALUES ("DN08","XD02","2023-01-14");
INSERT INTO DN_XD VALUES ("DN08","XD03","2023-01-14");
INSERT INTO DN_XD VALUES ("DN08","XD04","2023-01-14");
INSERT INTO DN_XD VALUES ("DN08","XD05","2023-01-14");
INSERT INTO DN_XD VALUES ("DN08","XD06","2023-01-14");
INSERT INTO DN_XD VALUES ("DN08","XD07","2023-01-14");
INSERT INTO DN_XD VALUES ("DN08","XD08","2023-01-14");
INSERT INTO DN_XD VALUES ("DN08","XD09","2023-01-14");
INSERT INTO DN_XD VALUES ("DN08","XD10","2023-01-14");
INSERT INTO DN_XD VALUES ("DN08","XD11","2023-01-14");
INSERT INTO DN_XD VALUES ("DN08","XD12","2023-01-14");
INSERT INTO DN_XD VALUES ("DN09","XD01","2023-03-09");
INSERT INTO DN_XD VALUES ("DN09","XD02","2023-03-09");
INSERT INTO DN_XD VALUES ("DN09","XD05","2023-03-09");
INSERT INTO DN_XD VALUES ("DN09","XD06","2023-03-09");
INSERT INTO DN_XD VALUES ("DN09","XD09","2023-03-09");
INSERT INTO DN_XD VALUES ("DN09","XD10","2023-03-09");
INSERT INTO DN_XD VALUES ("DN09","XD11","2023-03-09");
INSERT INTO DN_XD VALUES ("DN09","XD12","2023-03-09");
INSERT INTO DN_XD VALUES ("DN10","XD01","2023-01-14");
INSERT INTO DN_XD VALUES ("DN10","XD02","2023-01-09");
INSERT INTO DN_XD VALUES ("DN10","XD03","2023-01-09");
INSERT INTO DN_XD VALUES ("DN10","XD04","2023-01-09");
INSERT INTO DN_XD VALUES ("DN10","XD05","2023-01-09");
INSERT INTO DN_XD VALUES ("DN10","XD06","2023-01-09");
INSERT INTO DN_XD VALUES ("DN10","XD07","2023-01-09");
INSERT INTO DN_XD VALUES ("DN10","XD08","2023-01-09");
INSERT INTO DN_XD VALUES ("DN10","XD09","2023-01-09");
INSERT INTO DN_XD VALUES ("DN10","XD10","2023-01-09");
INSERT INTO DN_XD VALUES ("DN10","XD11","2023-01-09");
INSERT INTO DN_XD VALUES ("DN10","XD12","2023-01-09");
-- PHÂN QUYỀN

-- 1. Chủ doanh nghiệp nhập khẩu xăng dầu có quyền thêm trên bảng HOADON và CTHD 
CREATE USER 'dnnk'@'localhost' IDENTIFIED BY '123';
GRANT INSERT ON qlxd.HOADON TO 'dnnk'@'localhost';
GRANT INSERT ON qlxd.CTHD TO 'dnnk'@'localhost';
FLUSH PRIVILEGES;

-- 2. Chủ doanh nghiệp nhập khẩu có quyền xem trên tất cả các bảng 
GRANT SELECT ON qlxd.* TO 'dnnk'@'localhost';
FLUSH PRIVILEGES;

-- 3. Bộ Công Thương có toàn quyền trên tất cả các bảng 
CREATE USER 'BOCONGTHUONG'@'localhost' IDENTIFIED BY '000';
GRANT ALL PRIVILEGES ON qlxd.* TO 'BOCONGTHUONG'@'localhost';
FLUSH PRIVILEGES;

-- 4. Chủ cửa hàng kinh doanh xăng dầu có quyền xem trên tất cả các bảng 
CREATE USER 'cuahang'@'localhost' IDENTIFIED BY '456';
GRANT SELECT ON qlxd.* TO 'cuahang'@'localhost';
FLUSH PRIVILEGES;

-- TÌM KIẾM 
-- 1. Nhập vào tên xăng dầu, hiển thị giá nhập của xăng dầu đó 
DELIMITER $$
CREATE FUNCTION tinh_gianhap_xangdau(TEN VARCHAR(40))
RETURNS DECIMAL(10,3)
BEGIN
	DECLARE GIA DECIMAL(10,3);
	SELECT DISTINCT (GIACOSO + (THUEPHI * 1.0 / 100) * GIACOSO) INTO GIA  
    FROM XANGDAU
    WHERE UPPER(TENXD) LIKE UPPER(CONCAT("%",TEN,"%"));
    RETURN GIA;
END$$
DELIMITER ;

-- 1.1. THỰC THI 
SET @TEN = "e5 A92 vÙnG 2";
SELECT tinh_gianhap_xangdau(@TEN) AS GIANHAP;
-- 1.2. KIỂM TRA
SELECT * FROM CTHD ;
-- 1.3. XÓA 
DROP FUNCTION tinh_gianhap_xangdau;

-- THỐNG KÊ 
-- 1. Thống kê MAXD, TENXD, GIACOSO, THUEPHI, GIANHAP (đồng/lít) của các xăng dầu 
DELIMITER $$
CREATE PROCEDURE thongke_xangdau ()
BEGIN
	SELECT DISTINCT MAXD, TENXD, GIACOSO, THUEPHI, tinh_gianhap_xangdau(TENXD) AS GIANHAP  
    FROM XANGDAU;
END$$
DELIMITER ;

-- 1.1. THỰC THI
CALL thongke_xangdau;
-- 1.2 XÓA
DROP PROCEDURE thongke_xangdau;

-- 2. Thống kê lịch sử nhập hàng của cửa hàng kinh doanh xăng dầu:
-- 		a. Người dùng nhập tên cửa hàng của mình, thời gian muốn thống kê (ví dụ thống kê trong năm 2023)
-- 		b. Hiển thị ngày hóa đơn, tên các xăng dầu trong hóa đơn đó, số lượng, giá nhập, tổng tiền 
DELIMITER $$
CREATE PROCEDURE thongke_cuahang_xangdau (IN TEN VARCHAR(40), THOIGIAN VARCHAR(10))
BEGIN
	SELECT NGHD, TENXD, SOLUONG, GIANHAP, SOLUONG*GIANHAP AS TONGTIEN
    FROM CUAHANG AS CH, HOADON AS H, CTHD AS C, XANGDAU AS X
    WHERE CH.MACH = H.MACH AND H.SOHD = C.SOHD AND C.MAXD = X.MAXD 
    AND UPPER(CH.TENCH) LIKE UPPER(CONCAT("%",TEN,"%"))
    AND H.NGHD LIKE CONCAT("%",THOIGIAN,"%");
END$$
DELIMITER ;

-- 2.1. THỰC THI
SET @TEN = "anh thư";
SET @THOIGIAN = "2023-02";
CALL thongke_cuahang_xangdau(@TEN,@THOIGIAN);

-- 2.2. XÓA
DROP PROCEDURE  thongke_cuahang_xangdau ;

-- 3. Thống kê số lượng xăng dầu theo số lượng nhập từ cao xuống thấp 
DELIMITER $$
CREATE PROCEDURE thongke_soluong_xangdau ()
BEGIN
	SELECT X.MAXD, TENXD, GIACOSO, THUEPHI, SUM(SOLUONG) AS TONGSOLUONG
    FROM CTHD AS C, XANGDAU AS X
    WHERE C.MAXD = X.MAXD 
    GROUP BY X.MAXD, TENXD, GIACOSO, THUEPHI
    ORDER BY TONGSOLUONG DESC;
END$$
DELIMITER ;

-- 3.1. THỰC THI 
CALL thongke_soluong_xangdau;

-- CRYSTAL REPORT 
-- 1. Tạo View để thống kê MAXD, TENXD, GIACOSO, THUEPHI, GIANHAP (đồng/lít) của các xăng dầu để các chủ cửa hàng xem
CREATE VIEW thongke_xangdau 
AS
	SELECT DISTINCT MAXD, TENXD, GIACOSO, THUEPHI, tinh_gianhap_xangdau(TENXD) AS GIANHAP  
    FROM XANGDAU;

-- 2. Tạo View để thống kê để xem cửa hàng nào nhập xăng dầu nào, số lượng (lít), tổng tiền (đồng)
CREATE VIEW thongke_cuahang_xangdau
AS
	SELECT CH.MACH, TENCH, X.MAXD, TENXD, SUM(SOLUONG) AS TONGSOLUONG, SUM(GIANHAP*SOLUONG) AS TONGTIEN   
    FROM CTHD AS C, XANGDAU AS X, CUAHANG AS CH, HOADON AS H 
    WHERE C.MAXD = X.MAXD AND H.MACH = CH.MACH AND H.SOHD = C.SOHD 
    GROUP BY MACH, TENCH, MAXD, TENXD;

-- 3. Tạo View để thống kê số lượng xăng dầu theo số lượng nhập từ cao xuống thấp 
CREATE VIEW thongke_soluong_xangdau
AS
    SELECT X.MAXD, TENXD, GIACOSO, THUEPHI, SUM(SOLUONG) AS TONGSOLUONG
    FROM CTHD AS C, XANGDAU AS X
    WHERE C.MAXD = X.MAXD 
    GROUP BY X.MAXD, TENXD, GIACOSO, THUEPHI
    ORDER BY TONGSOLUONG DESC;
